import React, { useEffect, useMemo, useState } from "react";
import "../App.css";
import { useNavigate } from "react-router-dom";
import { server_url } from "../config/config";


interface Product{
  id: number;
  name: string;
  price: number;
  image: string;
  category: string;
};

type Profile = {
  name: string;
  avatar?: string | null;
};

/*
const SAMPLE_PRODUCTS: Product[] = [
  { id: 1, name: "‡∏û‡∏ß‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ï‡∏£‡∏≤‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢", price: 45, image: "/images/key-kmitl.jpg",  category: "‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏•‡∏∂‡∏Å" },
  { id: 2, name: "‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå KMITL",           price: 30, image: "/images/sticker-kmitl.jpg", category: "‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏•‡∏∂‡∏Å" },
  { id: 3, name: "Casio FX-991EX",               price: 2150, image: "/images/casio-991ex.jpg",  category: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" },
  { id: 4, name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ì‡∏∞ Science 44",         price: 370, image: "/images/shirt-sci-44.jpg",  category: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤" },
  { id: 5, name: "Casio FX-350MS",               price: 900, image: "/images/casio-350ms.jpg",   category: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" },
  { id: 6, name: "‡∏´‡∏±‡∏ß‡πÄ‡∏Ç‡πá‡∏°‡∏Ç‡∏±‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏∏‡∏ë",            price: 40, image: "/images/buckle-thai.jpg",   category: "‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏•‡∏∂‡∏Å" },
];
*/

const CATEGORIES = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏•‡∏∂‡∏Å", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤"];

export default function Shop() {
  // ===== profile from localStorage =====
  const [profile, setProfile] = useState<Profile | null>(null);
  const nav = useNavigate();

  // ===== Products =====
  const [products, setProducts] = useState<Product[]>();
  // request products from server
  useEffect(() => {
    const request_url: string = `${server_url}/product`;
    fetch(request_url)
      .then((res) => res.json())
      .then((json: Product[]) => setProducts(json));
  }, []);
  console.log(`the product: ${products}`);
  useEffect(() => {
    try {
      const raw = localStorage.getItem("user");
      if (!raw) return;
      const u = JSON.parse(raw);
      const name =
        `${u.firstName || ""} ${u.lastName || ""}`.trim() || u.email || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà";
      const avatar = u.avatarUrl || "/images/default-avatar.jpg";
      setProfile({ name, avatar });
    } catch {
      // ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    }
  }, []);

  // ===== search & filter =====
  const [query, setQuery] = useState("");
  const [activeCat, setActiveCat] = useState("‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    /*
    return SAMPLE_PRODUCTS.filter((p) => {
      const byCat = activeCat === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || p.category === activeCat;
      const byQ = !q || p.name.toLowerCase().includes(q);
      return byCat && byQ;
    });
    */
    if (products){
      return products.filter((p) => {
        const byCat = activeCat === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || p.category === activeCat;
        const byQ = !q || p.name.toLowerCase().includes(q);
        return byCat && byQ;
      });
    }
    return [];
  // }, [query, activeCat]);
  }, [products, query, activeCat]);

  // ===== actions =====
  const addToCart = (prod: Product) => {
    const raw = localStorage.getItem("cart");
    const cart: Product[] = raw ? JSON.parse(raw) : [];
    cart.push(prod);
    localStorage.setItem("cart", JSON.stringify(cart));
    alert(`‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤: ${prod.name}`);
  };

  const payNow = (prod: Product) => {
    alert(`‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${prod.name} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${prod.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
    // TODO: ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ checkout / QR / promptpay
  };

  return (
    <div className="shop-shell">
      {/* Header */}
      <header className="shop-header">
        <div className="shop-brand">
          <div className="brand-cart" />
        </div>

        <div className="shop-search">
          <input
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç, ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ì‡∏∞..."
          />
          <button aria-label="search">üîç</button>
        </div>

        <div className="shop-actions">
        <button className="cart-btn" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤" onClick={() => nav("/cart")}>üõçÔ∏è</button>
        </div>
      </header>

      {/* Body */}
      <div className="shop-body">
        {/* Main */}
        <main className="shop-main">
          {/* Tabs */}
          <div className="shop-tabs">
            {CATEGORIES.map((c) => (
              <button
                key={c}
                onClick={() => setActiveCat(c)}
                className={c === activeCat ? "tab active" : "tab"}
              >
                {c}
              </button>
            ))}
          </div>

          {/* Banner */}
          <div className="shop-banner">
            <div className="banner-dot" />
            <div className="banner-title">‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</div>
          </div>

          {/* Grid */}
          <section className="shop-grid">
            {filtered.map((p) => (
              <article className="product-card" key={p.id}>
                <div className="product-thumb">
                  <img src={p.image} alt={p.name} />
                </div>

                <div className="product-meta">
                  <h3 className="product-price">
                    {p.price.toLocaleString()} <span>‡∏ö‡∏≤‡∏ó</span>
                  </h3>
                  <div className="product-row">
                    <button className="ghost" onClick={() => addToCart(p)}>üõçÔ∏è</button>
                    <button className="pay" onClick={() => payNow(p)}>‡∏à‡πà‡∏≤‡∏¢</button>
                  </div>
                </div>

                <div className="product-name" title={p.name}>{p.name}</div>
              </article>
            ))}
          </section>
        </main>

        {/* Aside */}
        <aside className="shop-aside">
          <div className="profile-card">
            <div className="avatar">
              <img
                src={profile?.avatar || "/images/default-avatar.jpg"}
                alt={profile?.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà"}
              />
            </div>
            <div className="profile-name">{profile?.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà"}</div>
          </div>

          <nav className="profile-menu">
          
            
            <nav className="profile-menu">
                <button onClick={() => nav("/orders")}>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
               
            </nav>
          </nav>
        </aside>
      </div>
    </div>
  );
}
